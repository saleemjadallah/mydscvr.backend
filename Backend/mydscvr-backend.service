[Unit]
Description=MyDSCVR Backend API Service (MongoDB)
After=network.target mongodb.service
Wants=network.target

[Service]
Type=exec
User=ubuntu
Group=ubuntu
WorkingDirectory=/home/ubuntu/mydscvr-backend/Backend

# Environment variables
Environment="PATH=/home/ubuntu/mydscvr-backend/venv/bin:/usr/local/bin:/usr/bin:/bin"
Environment="VIRTUAL_ENV=/home/ubuntu/mydscvr-backend/venv"
Environment="PYTHONPATH=/home/ubuntu/mydscvr-backend/Backend"
Environment="PYTHONUNBUFFERED=1"

# Load environment variables from Backend.env file
EnvironmentFile=-/home/ubuntu/mydscvr-backend/Backend/Backend.env

# Pre-start dependency check
ExecStartPre=/bin/bash -c 'cd /home/ubuntu/mydscvr-backend && source venv/bin/activate && pip install -q requests jinja2 PyJWT'

# Main service command
ExecStart=/home/ubuntu/mydscvr-backend/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --log-level info --workers 1

# Restart configuration
Restart=always
RestartSec=10
KillMode=mixed
KillSignal=SIGTERM
TimeoutStopSec=30

# Output logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=mydscvr-backend

# Resource limits
LimitNOFILE=65536
LimitNPROC=4096

# Security hardening (production-ready)
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=read-only
ReadWritePaths=/home/ubuntu/mydscvr-backend/Backend/logs
ReadWritePaths=/home/ubuntu/mydscvr-backend/Backend/storage

[Install]
WantedBy=multi-user.target